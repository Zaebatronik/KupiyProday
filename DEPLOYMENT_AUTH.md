# üîí –í–ù–ï–î–†–ï–ù–ò–ï –ó–ê–©–ò–©–Å–ù–ù–û–ô –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
## –°—Ç–∞—Ç—É—Å: ‚úÖ –ö–û–î –û–ë–ù–û–í–õ–Å–ù, –¢–†–ï–ë–£–ï–¢–°–Ø –ù–ê–°–¢–†–û–ô–ö–ê

---

## ‚úÖ –ß–¢–û –£–ñ–ï –°–î–ï–õ–ê–ù–û:

### 1. –°–æ–∑–¥–∞–Ω middleware –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
**–§–∞–π–ª:** `backend/src/middleware/auth.js`
- ‚úÖ `verifyTelegramAuth` - –ø—Ä–æ–≤–µ—Ä–∫–∞ hash –æ—Ç Telegram
- ‚úÖ `requireAdmin` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- ‚úÖ `checkNotBanned` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 2. –û–±–Ω–æ–≤–ª—ë–Ω Frontend
**–§–∞–π–ª:** `frontend/src/services/api.ts`
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ `initData` —Å hash (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
- ‚úÖ Fallback –Ω–∞ `initDataUnsafe` –¥–ª—è dev/testing

### 3. –ó–∞—â–∏—â–µ–Ω—ã –≤—Å–µ —Ä–æ—É—Ç—ã Backend

**users.js:**
- ‚úÖ PUT `/:id` - —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ñ–∏–ª—è
- ‚úÖ DELETE `/:id` - —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
- ‚úÖ POST `/:id/ban` - —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
- ‚úÖ POST `/:id/unban` - —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω

**listings.js:**
- ‚úÖ POST `/` - —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ + –Ω–µ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã–µ
- ‚úÖ PUT `/:id` - —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –∞–¥–º–∏–Ω
- ‚úÖ DELETE `/:id` - —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –∞–¥–º–∏–Ω
- ‚úÖ userId –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ auth (–Ω–µ –∏–∑ req.body)

**chats.js:**
- ‚úÖ POST `/find-or-create` - —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–∞
- ‚úÖ POST `/:id/messages` - senderId –∏–∑ auth (–Ω–µ –∏–∑ req.body)
- ‚úÖ POST `/:id/share-contacts` - userId –∏–∑ auth

**reports.js:**
- ‚úÖ POST `/` - —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ
- ‚úÖ GET `/` - —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω
- ‚úÖ PATCH `/:id/status` - —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω

---

## ‚ö†Ô∏è –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨:

### 1. –î–æ–±–∞–≤–∏—Ç—å TELEGRAM_BOT_TOKEN –≤ .env

```bash
# backend/.env (—Å–æ–∑–¥–∞–π—Ç–µ –µ—Å–ª–∏ –Ω–µ—Ç)
MONGODB_URI=mongodb+srv://kamarovdanila228:JybumQhsIGOGEzK6@kupyprodai.1iomu.mongodb.net/kupyprodai
TELEGRAM_BOT_TOKEN=YOUR_BOT_TOKEN_HERE
ADMIN_TELEGRAM_ID=670170626
PORT=5000
NODE_ENV=production
```

**–ì–¥–µ –≤–∑—è—Ç—å BOT_TOKEN:**
1. –û—Ç–∫—Ä—ã—Ç—å [@BotFather](https://t.me/BotFather) –≤ Telegram
2. –ù–∞–π—Ç–∏ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ
3. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∫–æ–º–∞–Ω–¥–æ–π `/token`
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω –≤ .env

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env –Ω–∞ Render.com

–ó–∞–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ Render.com –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```
TELEGRAM_BOT_TOKEN = –≤–∞—à_—Ç–æ–∫–µ–Ω
ADMIN_TELEGRAM_ID = 670170626
```

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ

```bash
cd backend
npm install dotenv
node src/server.js
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö:
```
‚úÖ Telegram auth verified: { userId: '670170626', username: 'admin' }
```

### 4. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ production

```bash
# Frontend
cd frontend
npm run build
# Deploy –Ω–∞ Cloudflare Pages

# Backend
git add .
git commit -m "feat: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram"
git push
# Render.com –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```bash
# ‚ùå –ë–ï–ó AUTH - –¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 401
curl -X POST https://kupiyproday.onrender.com/listings \
  -H "Content-Type: application/json" \
  -d '{"title":"Test"}'
# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: {"error":"Unauthorized"}

# ‚úÖ –° –ü–†–ê–í–ò–õ–¨–ù–´–ú AUTH - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
# (initData –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è Telegram WebApp –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:

```bash
# ‚ùå –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ù–ï –∞–¥–º–∏–Ω–æ–º - –¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 403
curl -X POST https://kupiyproday.onrender.com/users/123/ban \
  -H "x-telegram-init-data: user=%7B%22id%22%3A123%7D&auth_date=..."
# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç: {"error":"Forbidden: Admin access required"}

# ‚úÖ –ê–¥–º–∏–Ω –±–∞–Ω–∏—Ç - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
# (—Ç–æ–ª—å–∫–æ —Å ADMIN_TELEGRAM_ID = 670170626)
```

---

## üîê –ß–¢–û –¢–ï–ü–ï–†–¨ –ó–ê–©–ò–©–ï–ù–û:

### ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- Hash –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏
- –î–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã Telegram —Å–µ—Ä–≤–µ—Ä–æ–º
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –æ—Ç —á—É–∂–æ–≥–æ –∏–º–µ–Ω–∏

### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫
- –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –ù–µ–ª—å–∑—è –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –ø—Ä–∞–≤
- –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —á—É–∂–æ–≥–æ –∏–º–µ–Ω–∏
- –ù–µ–ª—å–∑—è —É–¥–∞–ª—è—Ç—å —á—É–∂–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è

### ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- –ê–¥–º–∏–Ω –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
- –ó–∞–±–∞–Ω–µ–Ω–Ω—ã–µ –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç

---

## üìù –ú–ò–ì–†–ê–¶–ò–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –î–ê–ù–ù–´–•

–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è/—á–∞—Ç—ã –ù–ï —Ç—Ä–µ–±—É—é—Ç –º–∏–≥—Ä–∞—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫:
- `userId` —É–∂–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ Telegram ID
- Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û:

### –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (Development):
- –ï—Å–ª–∏ `initData` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –Ω–∞ `initDataUnsafe`
- ‚ö†Ô∏è –≠—Ç–æ –ù–ï –±–µ–∑–æ–ø–∞—Å–Ω–æ! –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!

### –†–µ–∂–∏–º production:
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ hash
- –ë–µ–∑ `TELEGRAM_BOT_TOKEN` middleware –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π `initData`

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢:

```bash
# 1. –ü–æ–ª—É—á–∏—Ç—å bot token –æ—Ç @BotFather
# 2. –î–æ–±–∞–≤–∏—Ç—å –≤ backend/.env:
echo "TELEGRAM_BOT_TOKEN=your_token_here" >> backend/.env

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
cd backend
npm install
node src/server.js

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "‚úÖ Telegram auth verified"

# 5. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å
git add .
git commit -m "feat: –∑–∞—â–∏—â—ë–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"
git push
```

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê:

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend: `‚úÖ Telegram auth verified` –∏–ª–∏ `‚ùå Invalid hash`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `TELEGRAM_BOT_TOKEN` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `x-telegram-init-data` header
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä DevTools ‚Üí Network ‚Üí Headers

---

**–°–æ–∑–¥–∞–Ω–æ:** 26 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** üü¢ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ .env
